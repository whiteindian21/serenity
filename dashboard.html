<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Therapathy - Healing Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #5E60CE;
      --primary-light: #E0E1FF;
      --primary-dark: #4A4DC7;
      --secondary: #64DFDF;
      --accent: #FF6B6B;
      --dark: #25274D;
      --light: #F8F9FF;
      --gray: #8A9BA8;
      --gray-light: #E2E8F0;
      --success: #48BB78;
      --warning: #F6AD55;
      --error: #E53E3E;
      --transition: all 0.3s ease;
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 10px;
      --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
      --shadow-medium: 0 6px 18px rgba(0, 0, 0, 0.08);
      --shadow-dark: 0 10px 30px rgba(0, 0, 0, 0.12);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      scroll-behavior: smooth;
      font-size: 16px;
    }

    body {
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--light);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      position: relative;
      overflow-x: hidden;
      background: radial-gradient(circle at 20% 30%, rgba(94, 96, 206, 0.05) 0%, transparent 50%),
                  radial-gradient(circle at 80% 70%, rgba(100, 223, 223, 0.05) 0%, transparent 50%);
      padding-bottom: calc(70px + var(--safe-area-inset-bottom));
    }

    h1, h2, h3, h4 {
      font-family: 'Merriweather', serif;
      font-weight: 700;
      line-height: 1.3;
      color: var(--dark);
    }

    p {
      color: var(--gray);
      font-size: 0.95rem;
    }

    .container {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      padding: 0 1rem;
      position: relative;
    }

    /* Mobile Header */
    .mobile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: white;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-light);
    }
    
    .app-logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 800;
      font-size: 1.2rem;
      color: var(--primary);
    }
    
    .app-logo i {
      font-size: 1.5rem;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      box-shadow: 0 4px 12px rgba(94, 96, 206, 0.25);
      cursor: pointer;
      transition: var(--transition);
    }

    .user-avatar:hover {
      transform: scale(1.1);
    }

    /* Dashboard Content */
    .dashboard-content {
      padding: 0.5rem;
      position: relative;
      overflow: hidden;
    }

    /* Dashboard Header - Removed */
    
    /* Cards */
    .card {
      background: rgba(255, 255, 255, 0.97);
      border-radius: var(--radius-md);
      padding: 1.2rem;
      margin: 1rem 0;
      position: relative;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: var(--shadow-light);
      animation: fadeIn 0.7s ease-out;
    }

    .card:hover {
      box-shadow: var(--shadow-medium);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: linear-gradient(to bottom, var(--primary), var(--secondary));
      border-radius: var(--radius-md) 0 0 var(--radius-md);
    }

    .card h3 {
      font-size: 1.2rem;
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .card h3 i {
      font-size: 1.1rem;
      color: var(--primary);
    }

    .affirmation-card {
      background: linear-gradient(135deg, rgba(94, 96, 206, 0.08), rgba(100, 223, 223, 0.08));
      border: 1px solid rgba(94, 96, 206, 0.18);
    }

    #affirmation {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--dark);
      position: relative;
      z-index: 1;
      line-height: 1.6;
      font-style: italic;
      padding: 0.8rem;
      background: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--primary);
    }

    .card-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.6rem;
      margin-top: 1rem;
    }

    .btn {
      padding: 0.8rem;
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      border: none;
      width: 100%;
      outline: none;
      font-family: 'Nunito', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 12px rgba(94, 96, 206, 0.35);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      transform: translateY(-3px);
      box-shadow: 0 6px 18px rgba(94, 96, 206, 0.45);
    }

    .btn-secondary {
      background: rgba(94, 96, 206, 0.12);
      color: var(--primary);
      border: 1px solid rgba(94, 96, 206, 0.25);
    }

    .btn-secondary:hover {
      background: rgba(94, 96, 206, 0.18);
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(94, 96, 206, 0.15);
    }

    .btn-accent {
      background: rgba(255, 107, 107, 0.12);
      color: var(--accent);
      border: 1px solid rgba(255, 107, 107, 0.25);
    }

    .btn-accent:hover {
      background: rgba(255, 107, 107, 0.18);
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.15);
    }

    .btn-sm {
      padding: 0.6rem;
      font-size: 0.85rem;
    }

    /* Action Cards */
    .action-cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.8rem;
      margin: 1.2rem 0;
    }

    @media (min-width: 768px) {
      .action-cards {
        grid-template-columns: 1fr 1fr;
      }
    }

    .action-card {
      background: rgba(255, 255, 255, 0.97);
      border-radius: var(--radius-md);
      padding: 1.2rem;
      transition: var(--transition);
      box-shadow: var(--shadow-light);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.3);
      animation: fadeIn 0.8s ease-out;
      height: 100%;
    }

    .action-card:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-4px);
    }

    .action-card i {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 0.8rem;
      background: rgba(94, 96, 206, 0.12);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .action-card h3 {
      margin-bottom: 0.6rem;
      color: var(--dark);
      font-size: 1.1rem;
    }

    .action-card p {
      color: var(--gray);
      font-size: 0.9rem;
      margin-bottom: 1.2rem;
      line-height: 1.5;
    }

    .action-card .btn {
      margin-top: auto;
      width: 100%;
    }

    /* Enhanced Breathing Exercise */
    .breath-container {
      position: relative;
      margin: 1.5rem auto;
      width: 180px;
      height: 180px;
    }
    
    .breath-circle {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.3rem;
      font-weight: 700;
      transition: all 1.5s ease-in-out;
      position: absolute;
      top: 0;
      left: 0;
      box-shadow: 0 6px 20px rgba(94, 96, 206, 0.35);
      z-index: 2;
    }
    
    .breath-circle.pulse {
      animation: pulse 4s infinite alternate;
    }
    
    .breath-visual {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      z-index: 1;
      opacity: 0.3;
      transition: all 1.5s ease-in-out;
    }
    
    .breath-phase {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(94, 96, 206, 0.1);
      z-index: 0;
      animation: breathPhase 16s infinite linear;
    }
    
    .breath-phase::before,
    .breath-phase::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(94, 96, 206, 0.1);
      opacity: 0;
      animation: breathPhase 16s infinite linear;
    }
    
    .breath-phase::before {
      animation-delay: -4s;
    }
    
    .breath-phase::after {
      animation-delay: -8s;
    }
    
    .breath-stats {
      display: flex;
      justify-content: space-around;
      margin: 1.5rem 0;
    }
    
    .breath-stat {
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--gray);
      margin-top: 0.3rem;
      font-weight: 600;
    }
    
    .breath-instruction {
      font-size: 1.1rem;
      margin: 1.2rem 0;
      color: var(--dark);
      font-weight: 600;
      text-align: center;
      padding: 0.8rem;
      background: rgba(94, 96, 206, 0.08);
      border-radius: var(--radius-sm);
      transition: all 0.5s ease;
    }
    
    .breath-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.6rem;
      margin-top: 0.8rem;
    }

    /* Memory Section */
    .memory-container {
      display: flex;
      overflow-x: auto;
      gap: 0.8rem;
      margin-top: 1.2rem;
      padding-bottom: 0.5rem;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .memory-container::-webkit-scrollbar {
      display: none;
    }
    
    .memory-item {
      flex: 0 0 auto;
      width: 90px;
      height: 90px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, rgba(94, 96, 206, 0.12), rgba(100, 223, 223, 0.12));
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 1.8rem;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid rgba(94, 96, 206, 0.2);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-light);
      background-size: cover;
      background-position: center;
    }
    
    .memory-item:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-medium);
    }
    
    .memory-item.add-memory {
      background: rgba(255, 255, 255, 0.7);
      border: 2px dashed rgba(94, 96, 206, 0.35);
      color: var(--gray);
    }
    
    .memory-item.add-memory:hover {
      background: rgba(94, 96, 206, 0.12);
      color: var(--primary);
    }
    
    .memory-label {
      position: absolute;
      bottom: 8px;
      left: 0;
      right: 0;
      font-size: 0.7rem;
      text-align: center;
      color: var(--dark);
      padding: 0 5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.85);
      padding: 4px;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    }
    
    .memory-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: -1;
    }
    
    .memory-item.has-image i {
      display: none;
    }
    
    .memory-item.has-image .memory-label {
      background: rgba(0, 0, 0, 0.7);
      color: white;
    }

    /* Mood Tracker */
    .mood-options {
      display: flex;
      overflow-x: auto;
      gap: 0.6rem;
      margin: 1.2rem 0;
      padding-bottom: 0.5rem;
      scrollbar-width: none;
    }
    
    .mood-options::-webkit-scrollbar {
      display: none;
    }

    .mood-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 0.8rem 0.5rem;
      border-radius: var(--radius-sm);
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(94, 96, 206, 0.15);
      box-shadow: var(--shadow-light);
      flex: 0 0 auto;
      width: 75px;
    }

    .mood-option:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-medium);
    }

    .mood-emoji {
      font-size: 1.8rem;
      margin-bottom: 0.4rem;
      transition: var(--transition);
    }

    .mood-label {
      font-size: 0.8rem;
      color: var(--gray);
      font-weight: 600;
    }

    .mood-option.selected {
      background: rgba(94, 96, 206, 0.15);
      border: 1px solid rgba(94, 96, 206, 0.35);
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(94, 96, 206, 0.15);
    }

    .mood-option.selected .mood-emoji {
      transform: scale(1.2);
    }

    .quick-actions {
      display: flex;
      gap: 0.6rem;
      margin-top: 1rem;
    }

    /* Activity Section */
    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      padding: 0.8rem;
      border-radius: var(--radius-sm);
      transition: background 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(94, 96, 206, 0.15);
      box-shadow: var(--shadow-light);
    }

    .activity-item:hover {
      background: rgba(94, 96, 206, 0.08);
      transform: translateX(4px);
    }

    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
      flex-shrink: 0;
      box-shadow: 0 4px 10px rgba(94, 96, 206, 0.25);
    }

    .activity-title {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 0.2rem;
      color: var(--dark);
    }

    .activity-time {
      font-size: 0.85rem;
      color: var(--gray);
      font-weight: 500;
    }

    /* Progress Section */
    .progress-bar {
      height: 10px;
      background: var(--gray-light);
      border-radius: 6px;
      margin: 1.2rem 0;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      height: 100%;
      width: 65%;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      border-radius: 6px;
      transition: width 1s ease;
      box-shadow: 0 2px 8px rgba(94, 96, 206, 0.3);
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--gray);
      font-weight: 600;
    }
    
    /* Progress sources indicator */
    .progress-sources {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
      gap: 0.5rem;
    }
    
    .progress-source {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }
    
    .progress-source-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
      color: white;
    }
    
    .progress-source-value {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--primary);
    }
    
    .progress-source-label {
      font-size: 0.75rem;
      color: var(--gray);
      text-align: center;
    }

    /* Companion Section */
    .companion-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 0.8rem;
      margin-top: 1rem;
    }

    .companion-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      box-shadow: 0 6px 18px rgba(94, 96, 206, 0.35);
      transition: transform 0.3s ease;
    }
    
    .companion-avatar:hover {
      transform: scale(1.08);
    }

    .companion-name {
      font-weight: 800;
      font-size: 1.3rem;
      color: var(--dark);
    }

    .companion-role {
      font-size: 0.95rem;
      color: var(--gray);
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .companion-specialties {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .specialty-tag {
      background: rgba(94, 96, 206, 0.12);
      color: var(--primary);
      padding: 0.4rem 0.8rem;
      border-radius: 30px;
      font-size: 0.85rem;
      font-weight: 700;
      border: 1px solid rgba(94, 96, 206, 0.25);
      transition: var(--transition);
      box-shadow: var(--shadow-light);
    }
    
    .specialty-tag:hover {
      background: rgba(94, 96, 206, 0.2);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--gray-light);
      display: flex;
      justify-content: space-around;
      padding: 0.6rem 0;
      z-index: 100;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding-bottom: calc(0.6rem + var(--safe-area-inset-bottom));
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--gray);
      font-size: 0.75rem;
      text-decoration: none;
      transition: var(--transition);
      flex: 1;
      padding: 0.3rem;
    }
    
    .nav-item i {
      font-size: 1.2rem;
      margin-bottom: 0.2rem;
    }
    
    .nav-item.active {
      color: var(--primary);
    }
    
    .nav-item:hover {
      transform: translateY(-3px);
      color: var(--primary);
    }
    
    .nav-item .nav-label {
      font-weight: 600;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(94, 96, 206, 0.45);
      }
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 12px rgba(94, 96, 206, 0);
      }
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(94, 96, 206, 0);
      }
    }
    
    @keyframes breathPhase {
      0% { transform: scale(0.8); opacity: 0; }
      12.5% { transform: scale(1.2); opacity: 0.8; }
      25% { transform: scale(1.5); opacity: 0; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease forwards;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 1.2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--dark);
      color: white;
      padding: 0.8rem 1.2rem;
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      font-weight: 600;
      box-shadow: var(--shadow-dark);
      z-index: 3000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 90%;
      text-align: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: rgba(37, 39, 77, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      background: rgba(72, 187, 120, 0.95);
    }
    
    .toast.error {
      background: rgba(229, 62, 62, 0.95);
    }
    
    .toast.info {
      background: rgba(94, 96, 206, 0.95);
    }

    /* Login Prompt */
    .login-prompt {
      background: white;
      border-radius: var(--radius-md);
      padding: 2rem 1.2rem;
      text-align: center;
      max-width: 500px;
      margin: 2rem auto;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--gray-light);
      animation: fadeIn 0.8s ease-out;
    }
    
    .login-prompt h2 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    
    .login-prompt p {
      margin-bottom: 1.5rem;
      color: var(--gray);
      font-size: 1rem;
      line-height: 1.7;
    }
    
    .btn-login {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.8rem;
      box-shadow: var(--shadow-medium);
      font-family: 'Nunito', sans-serif;
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      justify-content: center;
    }
    
    .btn-login:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-dark);
    }

    /* Sign out button */
    .btn-signout {
      background: none;
      border: none;
      color: var(--gray);
      font-size: 1.1rem;
      cursor: pointer;
      transition: var(--transition);
      padding: 0.4rem;
      border-radius: 50%;
    }
    
    .btn-signout:hover {
      color: var(--primary);
      background: rgba(94, 96, 206, 0.12);
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background: white;
      border-radius: var(--radius-lg);
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-dark);
      animation: scaleIn 0.3s ease-out;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .close-modal:hover {
      color: var(--primary);
    }
    
    .form-group {
      margin-bottom: 1.2rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
    }
    
    .form-control {
      width: 100%;
      padding: 0.8rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--gray-light);
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(94, 96, 206, 0.2);
    }
    
    .btn-save {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 1rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1rem;
      width: 100%;
      margin-top: 1rem;
    }
    
    .btn-save:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-dark);
    }
    
    .memory-form input[type="file"] {
      display: none;
    }
    
    .memory-label-upload {
      display: block;
      padding: 1rem;
      background: rgba(94, 96, 206, 0.1);
      border-radius: var(--radius-md);
      text-align: center;
      cursor: pointer;
      border: 2px dashed rgba(94, 96, 206, 0.3);
      transition: var(--transition);
      margin-bottom: 1rem;
    }
    
    .memory-label-upload:hover {
      background: rgba(94, 96, 206, 0.2);
    }
    
    .mood-history-container {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
    }
    
    .mood-entry {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .mood-emoji-history {
      font-size: 1.5rem;
    }
    
    .chart-container {
      height: 250px;
      margin-top: 1rem;
    }
    
    /* Memory preview */
    .memory-preview {
      width: 100%;
      height: 200px;
      border-radius: var(--radius-md);
      background-color: var(--light);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .memory-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
    }
    
    .memory-preview i {
      font-size: 3rem;
      color: var(--gray);
    }
    
    /* View memory modal */
    .memory-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    /* Memory Book Modal */
    .memory-book {
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .memory-book-entry {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--gray-light);
      gap: 1rem;
    }
    
    .memory-book-thumbnail {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-sm);
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }
    
    .memory-book-details {
      flex: 1;
    }
    
    .memory-book-title {
      font-weight: 600;
      color: var(--dark);
    }
    
    .memory-book-date {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .memory-book-progress {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(94, 96, 206, 0.05);
      border-radius: var(--radius-md);
    }
    
    .memory-book-progress h4 {
      margin-bottom: 0.5rem;
      color: var(--primary);
    }
    
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    /* Chat Interface */
    .chat-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: 65vh;
      max-height: 100%;
      background: white;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      box-shadow: var(--shadow-dark);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
      transform: translateY(100%);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      border: 1px solid rgba(94, 96, 206, 0.1);
      touch-action: none;
    }
    
    .chat-container.active {
      transform: translateY(0);
      opacity: 1;
    }
    
    .chat-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      position: relative;
    }
    
    .chat-header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-weight: 600;
      font-size: 1.2rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .chat-header h3 {
      flex: 1;
      font-size: 1.1rem;
      font-weight: 500;
      font-family: 'Nunito', sans-serif;
    }
    
    .close-chat {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .close-chat:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .chat-messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      -webkit-overflow-scrolling: touch;
      background: var(--light);
    }
    
    .message {
      max-width: 85%;
      padding: 0.8rem 1rem;
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      position: relative;
      word-break: break-word;
      line-height: 1.5;
      animation: fadeIn 0.3s ease;
    }
    
    .message.user {
      background: white;
      align-self: flex-end;
      border-top-right-radius: 0;
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(94, 96, 206, 0.1);
    }
    
    .message.companion {
      background: white;
      align-self: flex-start;
      border-top-left-radius: 0;
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(0, 206, 201, 0.1);
    }
    
    .message-time {
      font-size: 0.7rem;
      color: var(--gray);
      margin-top: 0.3rem;
      text-align: right;
    }
    
    .chat-input {
      display: flex;
      padding: 0.8rem;
      border-top: 1px solid rgba(94, 96, 206, 0.1);
      background: white;
    }
    
    .chat-input input {
      flex: 1;
      padding: 0.8rem;
      border: 1px solid rgba(94, 96, 206, 0.2);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      font-family: 'Nunito', sans-serif;
      transition: var(--transition);
    }
    
    .chat-input input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(94, 96, 206, 0.2);
      outline: none;
    }
    
    .send-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .send-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    /* Spinner for loading states */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(94, 96, 206, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .spinner-text {
      display: inline-block;
      vertical-align: middle;
    }
    
    /* Chat button */
    .chat-fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-dark);
      z-index: 50;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .chat-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(94, 96, 206, 0.4);
    }
    
    .chat-fab i {
      font-size: 1.5rem;
    }
    
    /* Page sections for navigation */
    .page-section {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .page-section.active {
      display: block;
    }
    
    /* Mood chart */
    .mood-chart {
      width: 100%;
      height: 200px;
      margin-top: 1rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
      .card {
        padding: 1rem;
      }
      
      .breath-container {
        width: 160px;
        height: 160px;
      }
      
      .chat-container {
        height: 70vh;
      }
    }
    
    @media (min-width: 768px) {
      .container {
        max-width: 800px;
        padding: 0 1.5rem;
      }
      
      .action-cards {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="app-logo">
      <i class="fas fa-brain"></i>
      <span>Therapathy</span>
    </div>
    <div class="user-avatar" id="userInitialMobile" title="Profile">
      <span id="userInitialTextMobile">U</span>
    </div>
  </div>

  <!-- Dashboard Container -->
  <div class="container dashboard-container" id="dashboard-container" style="display: none;">
    <!-- Page Sections -->
    <div id="home-section" class="page-section active">
      <!-- Affirmation Card -->
      <div class="card affirmation-card" id="affirmationCard">
        <h3><i class="fas fa-quote-left"></i> Daily Affirmation</h3>
        <p id="affirmation">"Healing isn't about forgetting, it's about learning to carry your loss with grace."</p>
        <div class="card-actions">
          <button class="btn btn-secondary" id="refreshAffirmation">
            <i class="fas fa-sync-alt"></i> New
          </button>
          <button class="btn btn-accent" id="saveAffirmation">
            <i class="far fa-heart"></i> Save
          </button>
        </div>
      </div>

      <!-- Breathing Exercise -->
      <div class="card">
        <div class="section-title">
          <i class="fas fa-wind"></i>
          <h3>Calming Breath</h3>
        </div>
        <div class="breath-container">
          <div class="breath-visual"></div>
          <div class="breath-phase"></div>
          <div class="breath-circle pulse">
            <span id="breath-text">Breathe In</span>
          </div>
        </div>
        
        <div class="breath-stats">
          <div class="breath-stat">
            <div class="stat-value" id="cycle-count">0</div>
            <div class="stat-label">Cycles</div>
          </div>
          <div class="breath-stat">
            <div class="stat-value" id="timer">0:00</div>
            <div class="stat-label">Time</div>
          </div>
        </div>
        
        <div class="breath-instruction" id="instruction">
          Breathe in slowly through your nose...
        </div>
        
        <div class="breath-controls">
          <button class="btn btn-primary" id="start-breath">
            <i class="fas fa-play"></i> Start
          </button>
          <button class="btn btn-secondary" id="reset-breath">
            <i class="fas fa-redo"></i> Reset
          </button>
        </div>
      </div>
      
      <!-- Companion Section -->
      <div class="card">
        <div class="section-title">
          <i class="fas fa-comments"></i>
          <h3>Your Companion</h3>
        </div>
        
        <div class="companion-container">
          <div class="companion-avatar" id="companion-avatar">
            <i class="fas fa-smile"></i>
          </div>
          <div class="companion-name" id="companion-name">Elena</div>
          <div class="companion-role" id="companion-role">Healing Guide</div>
          
          <div class="companion-specialties" id="companion-specialties">
            <div class="specialty-tag">Grief</div>
            <div class="specialty-tag">Compassion</div>
            <div class="specialty-tag">Support</div>
          </div>
          
          <button class="btn btn-primary" id="start-chat-btn">
            <i class="fas fa-comment"></i> Start Chat
          </button>
        </div>
      </div>

      <!-- Mood Tracker -->
      <div class="card">
        <div class="section-title">
          <i class="fas fa-smile"></i>
          <h3>How You Feel</h3>
        </div>
        
        <div class="mood-options">
          <div class="mood-option" data-mood="awful">
            <div class="mood-emoji">üò¢</div>
            <div class="mood-label">Awful</div>
          </div>
          <div class="mood-option" data-mood="sad">
            <div class="mood-emoji">üòû</div>
            <div class="mood-label">Sad</div>
          </div>
          <div class="mood-option" data-mood="neutral">
            <div class="mood-emoji">üòê</div>
            <div class="mood-label">Neutral</div>
          </div>
          <div class="mood-option selected" data-mood="great">
            <div class="mood-emoji">üòä</div>
            <div class="mood-label">Great</div>
          </div>
        </div>
        
        <div class="quick-actions">
          <button class="btn btn-secondary btn-sm" id="mood-history">
            <i class="fas fa-history"></i> History
          </button>
          <button class="btn btn-secondary btn-sm" id="mood-insights">
            <i class="fas fa-chart-pie"></i> Insights
          </button>
        </div>
      </div>
    </div>
    
    <!-- Tools Page -->
    <div id="tools-section" class="page-section">
      <div class="card">
        <h3><i class="fas fa-tools"></i> Healing Tools</h3>
        <p>Explore our collection of therapeutic tools</p>
        
        <div class="action-cards">
          <div class="action-card" id="journal-btn">
            <i class="fas fa-book-open"></i>
            <h3>Journal</h3>
            <p>Express your thoughts with guided prompts</p>
            <button class="btn btn-primary">
              Begin <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          
          <div class="action-card" id="compassion-btn">
            <i class="fas fa-hand-holding-heart"></i>
            <h3>Self-Care</h3>
            <p>Exercises to cultivate self-kindness</p>
            <button class="btn btn-primary">
              Explore <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          
          <div class="action-card">
            <i class="fas fa-headphones"></i>
            <h3>Meditation Library</h3>
            <p>Calming meditations for grief and healing</p>
            <button class="btn btn-primary">
              Explore <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          
          <div class="action-card">
            <i class="fas fa-brain"></i>
            <h3>Cognitive Exercises</h3>
            <p>Tools to reframe negative thoughts</p>
            <button class="btn btn-primary">
              Begin <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Memories Page -->
    <div id="memories-section" class="page-section">
      <div class="card">
        <h3><i class="fas fa-memory"></i> Cherished Memories</h3>
        <p>Preserve and revisit special moments</p>
        
        <div class="memory-container" id="memory-container">
          <!-- Memories will be loaded here -->
        </div>
        
        <div class="memory-actions">
          <button class="btn btn-primary" id="memory-book-btn">
            <i class="fas fa-book"></i> Memory Book
          </button>
          <button class="btn btn-secondary" id="add-memory-btn">
            <i class="fas fa-plus"></i> Add New
          </button>
        </div>
      </div>
    </div>
    
    <!-- Profile Page -->
    <div id="profile-section" class="page-section">
      <div class="card">
        <div class="companion-container">
          <div class="user-avatar" style="width: 100px; height: 100px; font-size: 2rem;">
            <span id="profile-initial">U</span>
          </div>
          <div class="companion-name" id="profile-name">User Name</div>
          <div class="companion-role">Member since <span id="join-date">Jan 2023</span></div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 65%"></div>
        </div>
        <div class="progress-info">
          <span>Healing Progress</span>
          <span id="progress-percent">65%</span>
        </div>
        
        <div class="progress-sources">
          <div class="progress-source">
            <div class="progress-source-icon">
              <i class="fas fa-smile"></i>
            </div>
            <div class="progress-source-value" id="mood-source">12</div>
            <div class="progress-source-label">Moods</div>
          </div>
          <div class="progress-source">
            <div class="progress-source-icon">
              <i class="fas fa-comment"></i>
            </div>
            <div class="progress-source-value" id="chat-source">8</div>
            <div class="progress-source-label">Chats</div>
          </div>
          <div class="progress-source">
            <div class="progress-source-icon">
              <i class="fas fa-book"></i>
            </div>
            <div class="progress-source-value" id="journal-source">5</div>
            <div class="progress-source-label">Journals</div>
          </div>
        </div>
        
        <button class="btn btn-primary" style="margin-top: 1.5rem;" id="account-settings-btn">
          <i class="fas fa-cog"></i> Account Settings
        </button>
      </div>
      
      <!-- Sign Out Button -->
      <div style="text-align: center; margin: 1.5rem 0;">
        <button class="btn-signout" id="signout-btn" aria-label="Sign out">
          <i class="fas fa-sign-out-alt"></i> Sign Out
        </button>
      </div>
    </div>
    
    <!-- Floating Chat Button -->
    <div class="chat-fab" id="chat-fab">
      <i class="fas fa-comment-dots"></i>
    </div>
  </div>

  <!-- Login Prompt -->
  <div class="container login-prompt" id="login-prompt">
    <h2>Welcome to Therapathy</h2>
    <p>Please sign in to access your personalized healing tools, resources, and progress tracking.</p>
    <button class="btn-login" id="go-to-login">
      <i class="fas fa-sign-in-alt"></i> Go to Login Page
    </button>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="#" class="nav-item active" data-target="home-section">
      <i class="fas fa-home"></i>
      <span class="nav-label">Home</span>
    </a>
    <a href="#" class="nav-item" data-target="tools-section">
      <i class="fas fa-tools"></i>
      <span class="nav-label">Tools</span>
    </a>
    <a href="#" class="nav-item" data-target="memories-section">
      <i class="fas fa-memory"></i>
      <span class="nav-label">Memories</span>
    </a>
    <a href="#" class="nav-item" data-target="profile-section">
      <i class="fas fa-user"></i>
      <span class="nav-label">Profile</span>
    </a>
  </nav>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>
  
  <!-- Chat Interface -->
  <div class="chat-container" id="chat-container">
    <div class="chat-header">
      <div class="avatar">
        <i class="fas fa-smile"></i>
      </div>
      <h3 id="chat-title">Chat with Elena</h3>
      <button class="close-chat" id="close-chat" aria-label="Close chat">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="message companion">
        Hi there! I'm Elena, your healing companion. How are you feeling today?
        <div class="message-time">Just now</div>
      </div>
    </div>
    <div class="chat-input">
      <input type="text" id="chat-input" placeholder="Type your message...">
      <button class="send-btn" id="send-btn" aria-label="Send message">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>User Settings</h3>
        <button class="close-modal" id="close-settings">&times;</button>
      </div>
      
      <div class="form-group">
        <label for="user-name">Name</label>
        <input type="text" id="user-name" class="form-control" placeholder="Enter your name">
      </div>
      
      <div class="form-group">
        <label for="user-email">Email</label>
        <input type="email" id="user-email" class="form-control" placeholder="Enter your email">
      </div>
      
      <div class="form-group">
        <label for="loss-type">Primary Loss Type</label>
        <select id="loss-type" class="form-control">
          <option value="relationship">Relationship</option>
          <option value="loved-one">Loved One</option>
          <option value="pet">Pet</option>
          <option value="job">Job</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Healing Preferences</label>
        <div>
          <input type="checkbox" id="journal-reminders" checked>
          <label for="journal-reminders">Daily journal reminders</label>
        </div>
        <div>
          <input type="checkbox" id="affirmation-reminders" checked>
          <label for="affirmation-reminders">Daily affirmations</label>
        </div>
      </div>
      
      <button class="btn-save" id="save-settings">Save Settings</button>
    </div>
  </div>
  
  <!-- Mood History Modal -->
  <div class="modal" id="mood-history-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Your Mood History</h3>
        <button class="close-modal" id="close-mood-history">&times;</button>
      </div>
      
      <div class="mood-chart">
        <canvas id="moodChart"></canvas>
      </div>
      
      <div class="mood-history-container" id="mood-history-list">
        <!-- Mood history will be loaded here -->
      </div>
    </div>
  </div>
  
  <!-- Add Memory Modal -->
  <div class="modal" id="add-memory-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Memory</h3>
        <button class="close-modal" id="close-add-memory">&times;</button>
      </div>
      
      <form id="memory-form">
        <div class="form-group">
          <label for="memory-title">Memory Title</label>
          <input type="text" id="memory-title" class="form-control" placeholder="Enter a title for this memory" required>
        </div>
        
        <div class="form-group">
          <label for="memory-date">Date</label>
          <input type="date" id="memory-date" class="form-control" required>
        </div>
        
        <div class="form-group">
          <label for="memory-description">Description</label>
          <textarea id="memory-description" class="form-control" rows="3" placeholder="Describe this memory"></textarea>
        </div>
        
        <div class="form-group">
          <label>Add Photo</label>
          <label for="memory-image" class="memory-label-upload">
            <i class="fas fa-camera"></i> Choose Image
          </label>
          <input type="file" id="memory-image" accept="image/*">
          
          <div class="memory-preview" id="memory-preview">
            <i class="fas fa-image"></i>
          </div>
        </div>
        
        <button type="submit" class="btn-save">
          <i class="fas fa-save"></i> Save Memory
        </button>
      </form>
    </div>
  </div>
  
  <!-- Memory Book Modal -->
  <div class="modal" id="memory-book-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Your Memory Book</h3>
        <button class="close-modal" id="close-memory-book">&times;</button>
      </div>
      
      <div class="memory-book">
        <div class="memory-book-progress">
          <h4>Your Healing Journey</h4>
          <p>You've collected <span id="memory-count">0</span> memories so far. Each one represents a step in your healing journey.</p>
        </div>
        
        <div id="memory-book-entries">
          <!-- Memory entries will be loaded here -->
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://minchdfasfsrfrmvgqdn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pbmNoZGZhc2ZzcmZybXZncWRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwMDQyOTIsImV4cCI6MjA2NTU4MDI5Mn0.58MfL3Yud-XqhBTwr9-_n-7igX81SABq1eEoe1LzVnQ';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // State variables
    let currentMood = "great";
    let breathInterval;
    let isBreathingActive = false;
    let cycleCount = 0;
    let secondsElapsed = 0;
    let currentPhase = 0;
    let progress = 0;
    let currentUser = null;
    let moodChart = null;
    let currentCompanion = "elena";
    let conversationHistory = [];
    let memories = [];
    
    // Progress tracking
    let progressSources = {
      mood: 12,
      chat: 8,
      journal: 5,
      memories: 0
    };
    
    // Define companions
    const companions = {
      "elena": {
        name: "Elena",
        role: "Healing Guide",
        specialties: ["Grief", "Compassion", "Support"],
        avatar: "fas fa-smile",
        personality: "compassionate",
        intro: "Hi there! I'm Elena, your healing companion. How are you feeling today?",
        systemPrompt: "You are Elena, a compassionate healing guide specialized in grief support. Respond with warmth, empathy, and understanding. Ask open-ended questions to encourage reflection. Remember to be patient and non-judgmental."
      },
      "david": {
        name: "David",
        role: "Mindfulness Coach",
        specialties: ["Mindfulness", "Resilience", "Meditation"],
        avatar: "fas fa-leaf",
        personality: "calm",
        intro: "Hello, I'm David. I'm here to help you find peace and mindfulness on your healing journey.",
        systemPrompt: "You are David, a mindfulness coach. Your responses should be calming and focused on present-moment awareness. Guide users through breathing exercises and mindfulness techniques."
      },
      "sophia": {
        name: "Sophia",
        role: "Therapeutic Guide",
        specialties: ["Cognitive Therapy", "Self-Discovery", "Empowerment"],
        avatar: "fas fa-lightbulb",
        personality: "insightful",
        intro: "Hi, I'm Sophia. Let's explore your thoughts and feelings together to foster healing and growth.",
        systemPrompt: "You are Sophia, a therapeutic guide. Help users reframe negative thoughts and discover inner strengths. Ask probing questions to encourage self-discovery."
      }
    };
    
    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', async function() {
      // Check if user is logged in
      const isAuthenticated = await checkSession();
      
      if (isAuthenticated) {
        // Show dashboard for logged-in users
        document.getElementById('login-prompt').style.display = 'none';
        document.getElementById('dashboard-container').style.display = 'block';
        
        setGreeting();
        initBreathingExercise();
        setupEventListeners();
        updateProgressBar();
        showToast(`Welcome back!`, "success");
        
        // Load user-specific data
        loadCompanion();
        loadMoodHistory();
        loadProgress();
        loadMemories();
        
        // Initialize mood chart
        initMoodChart();
      } else {
        // Show login prompt for unauthenticated users
        document.getElementById('login-prompt').style.display = 'block';
        document.getElementById('dashboard-container').style.display = 'none';
      }
      
      // Setup login redirection button
      document.getElementById('go-to-login').addEventListener('click', function() {
        window.location.href = 'login.html';
      });
    });
    
    // Check user session
    async function checkSession() {
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        console.error('Error getting session:', error.message);
        return false;
      }
      
      if (data.session) {
        currentUser = data.session.user;
        document.getElementById('userInitialText').textContent = currentUser.email[0].toUpperCase();
        document.getElementById('userInitialTextMobile').textContent = currentUser.email[0].toUpperCase();
        document.getElementById('profile-initial').textContent = currentUser.email[0].toUpperCase();
        return true;
      }
      
      return false;
    }
    
    // Initialize breathing exercise
    function initBreathingExercise() {
      document.getElementById('cycle-count').textContent = cycleCount;
      document.getElementById('timer').textContent = '0:00';
      
      // Set initial color for breathing circle
      updateBreathingCircleColor();
    }
    
    // Update breathing circle color based on phase
    function updateBreathingCircleColor() {
      const breathCircle = document.querySelector('.breath-circle');
      switch(currentPhase) {
        case 0: // Inhale
          breathCircle.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
          breathCircle.style.boxShadow = '0 6px 20px rgba(94, 96, 206, 0.35)';
          break;
        case 1: // Hold
          breathCircle.style.background = 'linear-gradient(135deg, #5E60CE, #4A4DC7)';
          breathCircle.style.boxShadow = '0 6px 20px rgba(74, 77, 199, 0.35)';
          break;
        case 2: // Exhale
          breathCircle.style.background = 'linear-gradient(135deg, #64DFDF, #48BB78)';
          breathCircle.style.boxShadow = '0 6px 20px rgba(100, 223, 223, 0.35)';
          break;
        case 3: // Hold
          breathCircle.style.background = 'linear-gradient(135deg, #48BB78, #64DFDF)';
          breathCircle.style.boxShadow = '0 6px 20px rgba(72, 187, 120, 0.35)';
          break;
      }
    }
    
    // Start/stop breathing exercise
    function toggleBreathing() {
      if (!isBreathingActive) {
        startBreathing();
        document.getElementById('start-breath').innerHTML = '<i class="fas fa-pause"></i> Pause';
      } else {
        pauseBreathing();
        document.getElementById('start-breath').innerHTML = '<i class="fas fa-play"></i> Resume';
      }
      isBreathingActive = !isBreathingActive;
    }
    
    // Start breathing exercise
    function startBreathing() {
      const breathCircle = document.querySelector('.breath-circle');
      breathCircle.classList.add('pulse');
      
      breathInterval = setInterval(() => {
        secondsElapsed++;
        const minutes = Math.floor(secondsElapsed / 60);
        const seconds = secondsElapsed % 60;
        document.getElementById('timer').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        const phaseTime = secondsElapsed % 16;
        
        if (phaseTime < 4) {
          if (currentPhase !== 0) {
            currentPhase = 0;
            document.getElementById('breath-text').textContent = 'Breathe In';
            document.getElementById('instruction').textContent = 'Breathe in slowly through your nose...';
            updateBreathingCircleColor();
          }
        } else if (phaseTime < 8) {
          if (currentPhase !== 1) {
            currentPhase = 1;
            document.getElementById('breath-text').textContent = 'Hold';
            document.getElementById('instruction').textContent = 'Hold your breath...';
            updateBreathingCircleColor();
          }
        } else if (phaseTime < 12) {
          if (currentPhase !== 2) {
            currentPhase = 2;
            document.getElementById('breath-text').textContent = 'Breathe Out';
            document.getElementById('instruction').textContent = 'Exhale slowly through your mouth...';
            cycleCount++;
            document.getElementById('cycle-count').textContent = cycleCount;
            updateBreathingCircleColor();
          }
        } else {
          if (currentPhase !== 3) {
            currentPhase = 3;
            document.getElementById('breath-text').textContent = 'Hold';
            document.getElementById('instruction').textContent = 'Hold your breath...';
            updateBreathingCircleColor();
          }
        }
      }, 1000);
    }
    
    // Pause breathing exercise
    function pauseBreathing() {
      clearInterval(breathInterval);
      document.querySelector('.breath-circle').classList.remove('pulse');
    }
    
    // Reset breathing exercise
    function resetBreathing() {
      pauseBreathing();
      isBreathingActive = false;
      cycleCount = 0;
      secondsElapsed = 0;
      currentPhase = 0;
      document.getElementById('cycle-count').textContent = cycleCount;
      document.getElementById('timer').textContent = '0:00';
      document.getElementById('breath-text').textContent = 'Breathe In';
      document.getElementById('instruction').textContent = 'Breathe in slowly through your nose...';
      document.getElementById('start-breath').innerHTML = '<i class="fas fa-play"></i> Start';
      updateBreathingCircleColor();
    }
    
    // Set up all event listeners
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const target = this.dataset.target;
          
          // Update active nav item
          document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
          this.classList.add('active');
          
          // Show target section
          document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
          document.getElementById(target).classList.add('active');
        });
      });
      
      // Profile avatar click
      document.getElementById('userInitialMobile').addEventListener('click', function(e) {
        e.preventDefault();
        // Navigate to profile section
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        document.querySelector('.nav-item[data-target="profile-section"]').classList.add('active');
        
        document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
        document.getElementById('profile-section').classList.add('active');
      });
      
      // Affirmation refresh
      document.getElementById('refreshAffirmation').addEventListener('click', refreshAffirmation);
      
      // Mood tracking
      document.querySelectorAll('.mood-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('selected'));
          this.classList.add('selected');
          currentMood = this.dataset.mood;
          trackMood(currentMood);
        });
      });
      
      // Save buttons
      document.getElementById('saveAffirmation').addEventListener('click', function() {
        this.classList.toggle('active');
        this.innerHTML = this.classList.contains('active') 
          ? '<i class="fas fa-heart"></i> Saved' 
          : '<i class="far fa-heart"></i> Save';
        
        showToast(
          this.classList.contains('active') 
            ? "Affirmation saved" 
            : "Affirmation removed", 
          "success"
        );
      });
      
      // Sign out button
      document.getElementById('signout-btn').addEventListener('click', async function() {
        const { error } = await supabase.auth.signOut();
        if (error) {
          showToast("Sign out failed: " + error.message, "error");
        } else {
          showToast("Signed out successfully", "success");
          currentUser = null;
          // Redirect to login.html
          window.location.href = 'login.html';
        }
      });
      
      // Breathing exercise controls
      document.getElementById('start-breath').addEventListener('click', toggleBreathing);
      document.getElementById('reset-breath').addEventListener('click', resetBreathing);
      
      // Journal button
      document.getElementById('journal-btn').addEventListener('click', function() {
        // Simulate journal entry creation
        progressSources.journal++;
        updateProgressBar();
        saveProgress();
        showToast("Journal entry created", "success");
        window.location.href = 'journal.html';
      });
      
      // Compassion button
      document.getElementById('compassion-btn').addEventListener('click', function() {
        window.location.href = 'self-care.html';
      });
      
      // Mood history
      document.getElementById('mood-history').addEventListener('click', function() {
        document.getElementById('mood-history-modal').style.display = 'flex';
      });
      
      // Mood insights
      document.getElementById('mood-insights').addEventListener('click', async function() {
        document.getElementById('mood-history-modal').style.display = 'flex';
      });
      
      // Account settings button
      document.getElementById('account-settings-btn').addEventListener('click', function() {
        document.getElementById('settings-modal').style.display = 'flex';
      });
      
      // Close modals
      document.getElementById('close-settings').addEventListener('click', () => {
        document.getElementById('settings-modal').style.display = 'none';
      });
      
      document.getElementById('close-mood-history').addEventListener('click', () => {
        document.getElementById('mood-history-modal').style.display = 'none';
      });
      
      // Start chat with companion
      document.getElementById('start-chat-btn').addEventListener('click', startCompanionChat);
      
      // Floating chat button
      document.getElementById('chat-fab').addEventListener('click', startCompanionChat);
      
      // Chat interface
      document.getElementById('close-chat').addEventListener('click', closeChat);
      document.getElementById('send-btn').addEventListener('click', sendMessage);
      document.getElementById('chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      // Memory book button
      document.getElementById('memory-book-btn').addEventListener('click', function() {
        document.getElementById('memory-book-modal').style.display = 'flex';
        loadMemoryBook();
      });
      
      // Add memory button
      document.getElementById('add-memory-btn').addEventListener('click', function() {
        document.getElementById('add-memory-modal').style.display = 'flex';
      });
      
      // Close memory modals
      document.getElementById('close-add-memory').addEventListener('click', () => {
        document.getElementById('add-memory-modal').style.display = 'none';
      });
      
      document.getElementById('close-memory-book').addEventListener('click', () => {
        document.getElementById('memory-book-modal').style.display = 'none';
      });
      
      // Memory image preview
      document.getElementById('memory-image').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            const preview = document.getElementById('memory-preview');
            preview.innerHTML = '';
            const img = document.createElement('img');
            img.src = event.target.result;
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Save memory form
      document.getElementById('memory-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        await saveMemory();
      });
    }
    
    // Initialize mood chart
    function initMoodChart() {
      const ctx = document.getElementById('moodChart').getContext('2d');
      moodChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [{
            label: 'Mood Level',
            data: [3, 1, 2, 3, 4, 3, 4],
            borderColor: '#5E60CE',
            backgroundColor: 'rgba(94, 96, 206, 0.1)',
            borderWidth: 3,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: 0,
              max: 4,
              ticks: {
                callback: function(value) {
                  const moods = ['Awful', 'Sad', 'Neutral', 'Good', 'Great'];
                  return moods[value];
                }
              }
            }
          }
        }
      });
    }
    
    // Track mood
    async function trackMood(mood) {
      const moodLabels = {
        "awful": "Awful",
        "sad": "Sad",
        "neutral": "Neutral",
        "great": "Great"
      };
      
      try {
        const { error } = await supabase
          .from('mood_entries')
          .insert([
            { 
              user_id: currentUser.id, 
              mood: mood,
              created_at: new Date().toISOString()
            }
          ]);
        
        if (error) throw error;
        
        // Update progress
        progressSources.mood++;
        updateProgressBar();
        saveProgress();
        
        showToast(`Mood recorded: ${moodLabels[mood]}`, "success");
        loadMoodHistory();
      } catch (error) {
        showToast("Error saving mood: " + error.message, "error");
      }
    }
    
    // Update progress bar
    function updateProgressBar() {
      // Calculate total progress points
      const totalPoints = progressSources.mood * 1 + progressSources.chat * 2 + progressSources.journal * 3 + progressSources.memories * 2;
      progress = Math.min(100, Math.round(totalPoints * 100 / 50)); // 50 points = 100%
      
      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('progress-percent').textContent = `${progress}%`;
      
      // Update progress sources
      document.getElementById('mood-source').textContent = progressSources.mood;
      document.getElementById('chat-source').textContent = progressSources.chat;
      document.getElementById('journal-source').textContent = progressSources.journal;
    }
    
    // Save progress to localStorage
    function saveProgress() {
      if (!currentUser) return;
      localStorage.setItem(`progress_${currentUser.id}`, JSON.stringify(progressSources));
    }
    
    // Load progress from localStorage
    function loadProgress() {
      if (!currentUser) return;
      const savedProgress = localStorage.getItem(`progress_${currentUser.id}`);
      if (savedProgress) {
        progressSources = JSON.parse(savedProgress);
        updateProgressBar();
      }
    }
    
    // Generate new affirmation using OpenAI Edge Function
    async function refreshAffirmation() {
      const card = document.getElementById('affirmationCard');
      const affirmationElement = document.getElementById('affirmation');
      
      card.style.opacity = '0.7';
      affirmationElement.innerHTML = '<span class="spinner"></span> <span class="spinner-text">Generating with AI...</span>';
      
      try {
        // Fallback to local generation
        const affirmations = [
          "I am whole and complete just as I am.",
          "Every ending creates space for new beginnings.",
          "I release what no longer serves me and welcome new possibilities.",
          "Their love remains with me always.",
          "I carry their memory in my heart with gratitude.",
          "Grief is the price of love, and I am grateful for the love we shared.",
          "The love we shared remains forever in my heart.",
          "I am grateful for every moment we had together.",
          "Their paw prints are forever on my soul.",
          "My worth is not defined by my job title.",
          "Endings create space for new opportunities.",
          "I trust that the right path will reveal itself in time.",
          "I am stronger than I feel, wiser than I know, and more resilient than I realize.",
          "Healing isn't linear, and that's okay.",
          "I give myself permission to feel whatever I'm feeling."
        ];
        
        const affirmation = affirmations[Math.floor(Math.random() * affirmations.length)];
        affirmationElement.textContent = `"${affirmation}"`;
        showToast("Affirmation generated", "info");
      } finally {
        card.style.opacity = '1';
      }
    }
    
    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Set greeting based on time of day
    function setGreeting() {
      const hour = new Date().getHours();
      let greeting = 'Hello';
      if (hour < 12) greeting = 'Good morning';
      else if (hour < 18) greeting = 'Good afternoon';
      else greeting = 'Good evening';
      
      document.getElementById('greeting').textContent = `${greeting}, welcome to your healing space`;
    }
    
    // Load companion information
    async function loadCompanion() {
      try {
        // Get companion index from user metadata
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) throw error;
        
        currentCompanion = user.user_metadata?.companion || "elena";
        
        // Update UI
        document.getElementById('companion-name').textContent = companions[currentCompanion].name;
        document.getElementById('companion-role').textContent = companions[currentCompanion].role;
        document.getElementById('companion-avatar').innerHTML = `<i class="${companions[currentCompanion].avatar}"></i>`;
        
        // Update specialties
        const specialtiesContainer = document.getElementById('companion-specialties');
        specialtiesContainer.innerHTML = '';
        companions[currentCompanion].specialties.forEach(specialty => {
          const tag = document.createElement('div');
          tag.className = 'specialty-tag';
          tag.textContent = specialty;
          specialtiesContainer.appendChild(tag);
        });
        
      } catch (error) {
        showToast("Error loading companion: " + error.message, "error");
      }
    }
    
    // Start chat with companion
    function startCompanionChat() {
      document.getElementById('chat-container').classList.add('active');
      document.getElementById('chat-title').textContent = `Chat with ${companions[currentCompanion].name}`;
      
      // Reset conversation history
      conversationHistory = [
        {
          role: "system",
          content: companions[currentCompanion].systemPrompt
        },
        {
          role: "assistant",
          content: companions[currentCompanion].intro
        }
      ];
      
      // Clear chat messages and add intro
      const chatMessages = document.getElementById('chat-messages');
      chatMessages.innerHTML = '';
      
      const introMessage = document.createElement('div');
      introMessage.className = 'message companion';
      introMessage.innerHTML = `
        ${companions[currentCompanion].intro}
        <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
      `;
      chatMessages.appendChild(introMessage);
    }
    
    // Close chat
    function closeChat() {
      document.getElementById('chat-container').classList.remove('active');
    }
    
    // Send message to companion
    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      const chatMessages = document.getElementById('chat-messages');
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      // Add user message to UI
      const userMessage = document.createElement('div');
      userMessage.className = 'message user';
      userMessage.innerHTML = `${message}<div class="message-time">${timeString}</div>`;
      chatMessages.appendChild(userMessage);
      
      // Add to conversation history
      conversationHistory.push({
        role: "user",
        content: message
      });
      
      // Clear input
      input.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // Show thinking indicator
      const thinkingMessage = document.createElement('div');
      thinkingMessage.className = 'message companion';
      thinkingMessage.innerHTML = `<span class="spinner"></span> Thinking...`;
      chatMessages.appendChild(thinkingMessage);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      try {
        // Simulate AI response
        setTimeout(() => {
          // Remove thinking indicator
          chatMessages.removeChild(thinkingMessage);
          
          // Add AI response to UI
          const responseTime = new Date();
          const responseTimeString = responseTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          
          const responses = [
            "I understand how you feel. Would you like to talk more about this?",
            "That sounds challenging. Remember to be gentle with yourself during this process.",
            "Thank you for sharing that with me. How has this been affecting your daily life?",
            "I appreciate you opening up about this. What's one thing that brought you comfort today?",
            "Your feelings are valid. Would it help to explore some coping strategies together?"
          ];
          
          const response = responses[Math.floor(Math.random() * responses.length)];
          
          const companionMessage = document.createElement('div');
          companionMessage.className = 'message companion';
          companionMessage.innerHTML = `${response}<div class="message-time">${responseTimeString}</div>`;
          chatMessages.appendChild(companionMessage);
          
          chatMessages.scrollTop = chatMessages.scrollHeight;
          
          // Add to conversation history
          conversationHistory.push({
            role: "assistant",
            content: response
          });
          
          // Update progress
          progressSources.chat++;
          updateProgressBar();
          saveProgress();
        }, 1500);
        
      } catch (error) {
        console.error("Companion chat error:", error);
        chatMessages.removeChild(thinkingMessage);
        
        const errorMessage = document.createElement('div');
        errorMessage.className = 'message companion';
        errorMessage.innerHTML = `I'm having trouble connecting right now. Could you try again later?`;
        chatMessages.appendChild(errorMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
    
    // Load mood history
    async function loadMoodHistory() {
      if (!currentUser) return;
      
      try {
        const { data: moods, error } = await supabase
          .from('mood_entries')
          .select('mood, created_at')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(7);
        
        if (error) throw error;
        
        const historyContainer = document.getElementById('mood-history-list');
        historyContainer.innerHTML = '';
        
        moods.forEach(mood => {
          const moodLabels = {
            "awful": { emoji: "üò¢", label: "Awful" },
            "sad": { emoji: "üòû", label: "Sad" },
            "neutral": { emoji: "üòê", label: "Neutral" },
            "great": { emoji: "üòä", label: "Great" }
          };
          
          const moodData = moodLabels[mood.mood] || { emoji: "‚ùì", label: "Unknown" };
          const date = new Date(mood.created_at);
          const formattedDate = `${date.toLocaleDateString()}, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
          
          const entry = document.createElement('div');
          entry.className = 'mood-entry';
          entry.innerHTML = `
            <div>
              <span class="mood-emoji-history">${moodData.emoji}</span>
              <span>${moodData.label}</span>
            </div>
            <div>${formattedDate}</div>
          `;
          
          historyContainer.appendChild(entry);
        });
      } catch (error) {
        showToast("Error loading mood history: " + error.message, "error");
      }
    }
    
    // Load memories
    async function loadMemories() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await supabase
          .from('memories')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        memories = data || [];
        progressSources.memories = memories.length;
        updateProgressBar();
        
        const container = document.getElementById('memory-container');
        container.innerHTML = '';
        
        // Add existing memories
        memories.forEach(memory => {
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item has-image';
          
          if (memory.image_url) {
            memoryItem.style.backgroundImage = `url(${memory.image_url})`;
            const img = document.createElement('img');
            img.className = 'memory-image';
            img.src = memory.image_url;
            img.alt = 'Memory';
            memoryItem.appendChild(img);
          } else {
            const icon = document.createElement('i');
            icon.className = memory.icon || 'fas fa-heart';
            memoryItem.appendChild(icon);
          }
          
          const label = document.createElement('div');
          label.className = 'memory-label';
          label.textContent = memory.title || 'Memory';
          memoryItem.appendChild(label);
          
          memoryItem.addEventListener('click', () => viewMemory(memory));
          container.appendChild(memoryItem);
        });
        
        // Add "Add Memory" button
        const addMemory = document.createElement('div');
        addMemory.className = 'memory-item add-memory';
        addMemory.innerHTML = `
          <i class="fas fa-plus"></i>
          <div class="memory-label">Add Memory</div>
        `;
        addMemory.addEventListener('click', () => {
          document.getElementById('add-memory-modal').style.display = 'flex';
        });
        container.appendChild(addMemory);
        
      } catch (error) {
        showToast("Error loading memories: " + error.message, "error");
      }
    }
    
    // Save memory
    async function saveMemory() {
      const title = document.getElementById('memory-title').value;
      const date = document.getElementById('memory-date').value;
      const description = document.getElementById('memory-description').value;
      const imageFile = document.getElementById('memory-image').files[0];
      
      if (!title) {
        showToast("Please enter a title for your memory", "error");
        return;
      }
      
      try {
        let imageUrl = null;
        
        // Upload image if provided
        if (imageFile) {
          const fileExt = imageFile.name.split('.').pop();
          const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
          const filePath = `memories/${fileName}`;
          
          const { data, error: uploadError } = await supabase.storage
            .from('memory-images')
            .upload(filePath, imageFile);
          
          if (uploadError) throw uploadError;
          
          // Get public URL
          const { data: { publicUrl } } = supabase.storage
            .from('memory-images')
            .getPublicUrl(filePath);
          
          imageUrl = publicUrl;
        }
        
        // Save memory to database
        const { error } = await supabase
          .from('memories')
          .insert([{
            user_id: currentUser.id,
            title: title,
            date: date,
            description: description,
            image_url: imageUrl,
            created_at: new Date().toISOString()
          }]);
        
        if (error) throw error;
        
        showToast("Memory saved successfully", "success");
        document.getElementById('add-memory-modal').style.display = 'none';
        document.getElementById('memory-form').reset();
        document.getElementById('memory-preview').innerHTML = '<i class="fas fa-image"></i>';
        
        // Reload memories
        loadMemories();
        
      } catch (error) {
        showToast("Error saving memory: " + error.message, "error");
      }
    }
    
    // View memory details
    function viewMemory(memory) {
      // Create a modal to view memory details
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>${memory.title || 'Memory'}</h3>
            <button class="close-modal" id="close-view-memory">&times;</button>
          </div>
          
          ${memory.image_url ? `
            <div class="memory-preview">
              <img src="${memory.image_url}" alt="${memory.title}">
            </div>
          ` : ''}
          
          <div class="form-group">
            <label>Date</label>
            <p>${memory.date || 'No date specified'}</p>
          </div>
          
          ${memory.description ? `
            <div class="form-group">
              <label>Description</label>
              <p>${memory.description}</p>
            </div>
          ` : ''}
          
          <button class="btn btn-secondary" id="close-view-memory-btn" style="margin-top: 1rem;">
            Close
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal handlers
      document.getElementById('close-view-memory').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      document.getElementById('close-view-memory-btn').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
    }
    
    // Load memory book
    function loadMemoryBook() {
      const container = document.getElementById('memory-book-entries');
      container.innerHTML = '';
      
      document.getElementById('memory-count').textContent = memories.length;
      
      if (memories.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray);">No memories yet. Add some to track your healing journey.</p>';
        return;
      }
      
      memories.forEach(memory => {
        const entry = document.createElement('div');
        entry.className = 'memory-book-entry';
        
        entry.innerHTML = `
          <div class="memory-book-thumbnail" style="background-image: url(${memory.image_url || 'none'})">
            ${!memory.image_url ? `<i class="${memory.icon || 'fas fa-heart'}"></i>` : ''}
          </div>
          <div class="memory-book-details">
            <div class="memory-book-title">${memory.title || 'Memory'}</div>
            <div class="memory-book-date">${memory.date || 'No date'}</div>
          </div>
        `;
        
        entry.addEventListener('click', () => viewMemory(memory));
        container.appendChild(entry);
      });
    }
    
    // Save user settings
    async function saveSettings() {
      const name = document.getElementById('user-name').value;
      const email = document.getElementById('user-email').value;
      const lossType = document.getElementById('loss-type').value;
      
      try {
        const { error } = await supabase.auth.updateUser({
          email: email,
          data: { 
            name: name,
            loss_type: lossType,
            journal_reminders: document.getElementById('journal-reminders').checked,
            affirmation_reminders: document.getElementById('affirmation-reminders').checked
          }
        });
        
        if (error) throw error;
        
        showToast("Settings saved successfully", "success");
        document.getElementById('settings-modal').style.display = 'none';
        
        // Update UI with new name if available
        if (name) {
          document.getElementById('userInitialText').textContent = name[0].toUpperCase();
          document.getElementById('userInitialTextMobile').textContent = name[0].toUpperCase();
          document.getElementById('profile-initial').textContent = name[0].toUpperCase();
          document.getElementById('profile-name').textContent = name;
        }
      } catch (error) {
        showToast("Error saving settings: " + error.message, "error");
      }
    }
  </script>
</body>
</html>
